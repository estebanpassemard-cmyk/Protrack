<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProTrack V26</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; font-family: sans-serif; color: white; margin: 0; overflow: hidden; }
        .viewport { display: flex; width: 100vw; height: 100vh; overflow-x: auto; scroll-snap-type: x mandatory; }
        .page { flex: 0 0 100vw; width: 100vw; height: 100vh; scroll-snap-align: start; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .card { background: rgba(30, 41, 59, 0.8); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        input, select { background: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; font-size: 16px !important; }
        .btn { background: #3b82f6; color: white; font-weight: bold; padding: 15px; border-radius: 10px; width: 100%; border: none; margin-top: 10px; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #1e293b; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #334155; }
        .nav-item { color: #64748b; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .nav-item.active { color: #3b82f6; }
        .archive-btn { background: #1e293b; font-size: 10px; padding: 5px 10px; border-radius: 5px; border: 1px solid #475569; }
    </style>
</head>
<body>

<div class="viewport" id="vp">
    <div class="page">
        <h2 style="font-weight: 900; color: #64748b; margin-bottom: 20px;">SAISIE</h2>
        <div class="card">
            <input type="date" id="date">
            <input type="text" id="project" placeholder="NOM DU PROJET" list="list-p">
            <datalist id="list-p"></datalist>
            <select id="type" onchange="checkType()">
                <option value="Production">Production</option>
                <option value="Trajet">Trajet</option>
                <option value="Pose Piges">Pose Piges</option>
                <option value="Pose Omnes">Pose Omnes</option>
                <option value="Jours OFF">Jours OFF</option>
            </select>
            <div id="hours-div">
                <div style="display:grid; grid-template-cols: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div><small>MATIN DEBUT</small><input type="time" id="s1"></div>
                    <div><small>MATIN FIN</small><input type="time" id="e1"></div>
                    <div><small>APREM DEBUT</small><input type="time" id="s2"></div>
                    <div><small>APREM FIN</small><input type="time" id="e2"></div>
                </div>
            </div>
            <button class="btn" onclick="save()">ENREGISTRER</button>
        </div>
        <div id="recent"></div>
    </div>

    <div class="page">
        <h2 style="font-weight: 900; color: #64748b; margin-bottom: 20px;">BILAN FACTURATION</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <div class="card" style="text-align:center; margin:0;">
                <small style="color:#3b82f6">À FACTURER</small><br>
                <b id="t-p" style="font-size:18px">0 €</b>
            </div>
            <div class="card" style="text-align:center; margin:0;">
                <small style="color:#ef4444">FACTURÉ</small><br>
                <b id="t-b" style="font-size:18px">0 €</b>
            </div>
        </div>
        <div id="list-bilan"></div>
        <button onclick="copy('bilan')" class="btn" style="background:#475569">COPIER POUR NOTES</button>
    </div>

    <div class="page">
        <h2 style="font-weight: 900; color: #64748b; margin-bottom: 20px;">ARCHIVES</h2>
        <div id="list-archive"></div>
        <button onclick="copy('archive')" class="btn" style="background:#475569">COPIER ARCHIVES</button>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="go(0)">Saisie</div>
    <div class="nav-item" onclick="go(1)">Bilan</div>
    <div class="nav-item" onclick="go(2)">Archives</div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('protrack_db') || '[]');
    let billed = JSON.parse(localStorage.getItem('protrack_billed') || '[]');
    let archived = JSON.parse(localStorage.getItem('protrack_archived') || '[]');
    let prices = { prod: 25, trajet: 20, piges: 350, omnes: 300, off: 100 };

    document.getElementById('date').valueAsDate = new Date();

    function go(i) { document.getElementById('vp').scrollTo({left: i * window.innerWidth, behavior:'smooth'}); }

    function checkType() {
        let t = document.getElementById('type').value;
        document.getElementById('hours-div').style.display = (t.includes('Pose') || t === 'Jours OFF') ? 'none' : 'block';
    }

    function save() {
        try {
            const d = document.getElementById('date').value;
            const p = document.getElementById('project').value.toUpperCase() || "DIVERS";
            const t = document.getElementById('type').value;
            if(!d) return alert("Mets une date");

            let totalVal = 0;
            let info = "";

            if(t.includes('Pose') || t === 'Jours OFF') {
                totalVal = t === 'Pose Piges' ? prices.piges : (t === 'Pose Omnes' ? prices.omnes : prices.off);
                info = "FORFAIT";
            } else {
                const s1 = document.getElementById('s1').value, e1 = document.getElementById('e1').value;
                const s2 = document.getElementById('s2').value, e2 = document.getElementById('e2').value;
                
                const toMin = (v) => { if(!v) return 0; const [h,m] = v.split(':'); return parseInt(h)*60 + parseInt(m); };
                let m1 = toMin(e1) - toMin(s1);
                let m2 = toMin(e2) - toMin(s2);
                let totalMin = (m1 > 0 ? m1 : 0) + (m2 > 0 ? m2 : 0);
                
                if(totalMin === 0) return alert("Vérifie les heures");
                totalVal = (totalMin / 60) * (t === 'Production' ? prices.prod : prices.trajet);
                info = Math.floor(totalMin/60) + "h" + (totalMin%60);
            }

            db.unshift({ id: Date.now(), date: d, project: p, type: t, val: totalVal, info: info });
            localStorage.setItem('protrack_db', JSON.stringify(db));
            
            // Clear
            document.getElementById('project').value = "";
            ['s1','e1','s2','e2'].forEach(id => document.getElementById(id).value = "");
            
            render();
            alert("Enregistré !");
        } catch(e) { alert("Erreur: " + e.message); }
    }

    function render() {
        const rec = document.getElementById('recent');
        const bil = document.getElementById('list-bilan');
        const arc = document.getElementById('list-archive');
        
        // Accueil
        rec.innerHTML = '<small style="color:#64748b">DERNIERS ENREGISTREMENTS</small>';
        db.slice(0,3).forEach(l => {
            rec.innerHTML += `<div class="card" style="padding:10px; margin-top:5px; font-size:12px">
                <b>${l.project}</b> - ${l.val.toFixed(2)}€ <br> <small>${l.date} | ${l.type}</small>
            </div>`;
        });

        // Groupement pour Bilan et Archives
        let groups = db.reduce((acc, l) => {
            acc[l.project] = acc[l.project] || [];
            acc[l.project].push(l);
            return acc;
        }, {});

        bil.innerHTML = "";
        arc.innerHTML = "";
        let totP = 0, totB = 0;

        for (let p in groups) {
            let isA = archived.includes(p);
            let isB = billed.includes(p);
            let sum = groups[p].reduce((s, l) => s + l.val, 0);

            if(!isA) { if(isB) totB += sum; else totP += sum; }

            let html = `<div class="card" style="${isB && !isA ? 'border-left:4px solid #ef4444' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center mb-2">
                    <b>${p}</b> <span>${sum.toFixed(2)}€</span>
                </div>
                <div style="display:flex; gap:5px; margin-top:10px">
                    <button onclick="toggleB('${p}')" class="archive-btn">${isB ? 'OUVRIR' : 'FACTURÉ'}</button>
                    <button onclick="toggleA('${p}')" class="archive-btn">${isA ? 'DÉ-ARCHIVER' : 'ARCHIVER'}</button>
                </div>
            </div>`;

            if(isA) arc.innerHTML += html; else bil.innerHTML += html;
        }

        document.getElementById('t-p').innerText = totP.toFixed(2) + " €";
        document.getElementById('t-b').innerText = totB.toFixed(2) + " €";
    }

    function toggleB(p) {
        if(billed.includes(p)) billed = billed.filter(x => x !== p);
        else billed.push(p);
        localStorage.setItem('protrack_billed', JSON.stringify(billed));
        render();
    }

    function toggleA(p) {
        if(archived.includes(p)) archived = archived.filter(x => x !== p);
        else archived.push(p);
        localStorage.setItem('protrack_archived', JSON.stringify(archived));
        render();
    }

    function copy(mode) {
        let txt = "RECAP PROTRACK\n\n";
        db.forEach(l => {
            let isA = archived.includes(l.project);
            if((mode === 'archive' && isA) || (mode === 'bilan' && !isA)) {
                txt += `${l.date} | ${l.project} | ${l.type} | ${l.val.toFixed(2)}€\n`;
            }
        });
        navigator.clipboard.writeText(txt).then(() => alert("Copié !"));
    }

    render();
    // Update nav active state on scroll
    document.getElementById('vp').addEventListener('scroll', () => {
        let i = Math.round(document.getElementById('vp').scrollLeft / window.innerWidth);
        document.querySelectorAll('.nav-item').forEach((n, idx) => {
            n.classList.toggle('active', i === idx);
        });
    });
</script>

</body>
</html>
